<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Create Stylized GPU Instancing Billboard Grass Without Creating Position Buffer in URP | Tim (Yaotian) Huang</title>
<meta name="keywords" content="Unity, Shader, GPU Instancing, Grass, URP" />
<meta name="description" content="Environment Unity 2021.3.16f1
URP 12.0
Prerequisite Basic knowledge of C# and Shader programming (HLSL).
GPU Instancing GPU instancing is a technique that allows you to draw multiple copies of the same mesh using a single draw call. It is basically normal forward rendering pipeline but skipping the Vertex Specification stage.
Graphics.DrawMeshInstancedIndirect The first step to create multiple millions of grass is to properly call the GPU to draw so, a.k.a. draw call.">
<meta name="author" content="Tim Huang">
<link rel="canonical" href="https://www.yaotian-huang.com/en/ta/create-stylized-gpu-instancing-billboard-grass-without-creating-position-buffer-in-urp/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7bfe087ae72df31787ec7a1360dd05ee246a179b51cf7a30a904b39d7f813b69.css" integrity="sha256-e/4Ieuct8xeH7HoTYN0F7iRqF5tRz3owqQSznX&#43;BO2k=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.30d2332871da51f600f574811c17751e6c862577d450b624f86e2bc8a6e31221.js" integrity="sha256-MNIzKHHaUfYA9XSBHBd1HmyGJXfUULYk&#43;G4ryKbjEiE="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://www.yaotian-huang.com/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.yaotian-huang.com/images/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.yaotian-huang.com/images/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://www.yaotian-huang.com/images/apple-touch-icon.png">
<link rel="mask-icon" href="https://www.yaotian-huang.com/images/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://www.yaotian-huang.com/en/ta/create-stylized-gpu-instancing-billboard-grass-without-creating-position-buffer-in-urp/" />
<link rel="alternate" hreflang="jp" href="https://www.yaotian-huang.com/jp/ta/create-stylized-gpu-instancing-billboard-grass-without-creating-position-buffer-in-urp/" />
<link rel="alternate" hreflang="cn" href="https://www.yaotian-huang.com/cn/ta/create-stylized-gpu-instancing-billboard-grass-without-creating-position-buffer-in-urp/" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.yaotian-huang.com/en/" accesskey="h" title="Tim (Yaotian) Huang (Alt + H)">Tim (Yaotian) Huang</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://www.yaotian-huang.com/jp/ta/create-stylized-gpu-instancing-billboard-grass-without-creating-position-buffer-in-urp/" title="JP"
                            aria-label="JP">JP</a>
                    </li>
                    <li>
                        <a href="https://www.yaotian-huang.com/cn/ta/create-stylized-gpu-instancing-billboard-grass-without-creating-position-buffer-in-urp/" title="CN"
                            aria-label="CN">CN</a>
                    </li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home"><span>Home</span></a>
            </li>
            <li>
                <a href="https://www.yaotian-huang.com/en/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://www.yaotian-huang.com/en/ta/" title="TA">
                    <span>TA</span>
                </a>
            </li>
            <li>
                <a href="https://www.yaotian-huang.com/en/code/" title="Code">
                    <span>Code</span>
                </a>
            </li>
            <li>
                <a href="https://www.yaotian-huang.com/en/art/" title="Art">
                    <span>Art</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://www.yaotian-huang.com/en/">Home</a>&nbsp;»&nbsp;<a href="https://www.yaotian-huang.com/en/ta/">Technical Art</a></div>
    <h1 class="post-title">
      Create Stylized GPU Instancing Billboard Grass Without Creating Position Buffer in URP
    </h1>
    <div class="post-meta"><span title='2024-03-04 11:59:37 -0700 MST'>Mar 4, 2024</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;Tim Huang</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#environment" aria-label="Environment">Environment</a></li>
                <li>
                    <a href="#prerequisite" aria-label="Prerequisite">Prerequisite</a></li>
                <li>
                    <a href="#gpu-instancing" aria-label="GPU Instancing">GPU Instancing</a></li>
                <li>
                    <a href="#graphicsdrawmeshinstancedindirect" aria-label="Graphics.DrawMeshInstancedIndirect">Graphics.DrawMeshInstancedIndirect</a></li>
                <li>
                    <a href="#material" aria-label="Material">Material</a><ul>
                        
                <li>
                    <a href="#gpu-instancing-keywords-and-macros" aria-label="GPU Instancing Keywords and Macros">GPU Instancing Keywords and Macros</a></li>
                <li>
                    <a href="#material-property" aria-label="Material Property">Material Property</a></li>
                <li>
                    <a href="#local-position-offset" aria-label="Local Position Offset">Local Position Offset</a></li>
                <li>
                    <a href="#noise-texture-uv" aria-label="Noise Texture UV">Noise Texture UV</a></li>
                <li>
                    <a href="#static-gpu-instancing-grass-shader" aria-label="Static GPU Instancing Grass Shader">Static GPU Instancing Grass Shader</a></li></ul>
                </li>
                <li>
                    <a href="#noise" aria-label="Noise">Noise</a><ul>
                        
                <li>
                    <a href="#control-map" aria-label="Control Map">Control Map</a></li>
                <li>
                    <a href="#wind-map" aria-label="Wind Map">Wind Map</a></li></ul>
                </li>
                <li>
                    <a href="#final" aria-label="Final">Final</a><ul>
                        
                <li>
                    <a href="#shader" aria-label="Shader">Shader</a></li>
                <li>
                    <a href="#renderer" aria-label="Renderer">Renderer</a></li>
                <li>
                    <a href="#next-steps" aria-label="Next Steps">Next Steps</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content">
  <h2 id="environment">Environment</h2>
<p>Unity 2021.3.16f1<br>
URP 12.0</p>
<h2 id="prerequisite">Prerequisite</h2>
<p>Basic knowledge of C# and Shader programming (HLSL).</p>
<h2 id="gpu-instancing">GPU Instancing</h2>
<p>GPU instancing is a technique that allows you to draw multiple copies of the same mesh using a single draw call. It is basically normal forward rendering pipeline but skipping the Vertex Specification stage.</p>
<h2 id="graphicsdrawmeshinstancedindirect">Graphics.DrawMeshInstancedIndirect</h2>
<p>The first step to create multiple millions of grass is to properly call the GPU to draw so, a.k.a. draw call. In Unity, we can use <code>Graphics.DrawMeshInstancedIndirect</code> to create a GPU instancing draw call.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">// Graphics.cs</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">void</span> <span class="n">DrawMeshInstancedIndirect</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="n">Mesh</span> <span class="n">mesh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">submeshIndex</span><span class="p">,</span> <span class="n">Material</span> <span class="n">material</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="n">Bounds</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">ComputeBuffer</span> <span class="n">bufferWithArgs</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">argsOffset</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">MaterialPropertyBlock</span> <span class="n">properties</span> <span class="p">=</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">ShadowCastingMode</span> <span class="n">castShadows</span> <span class="p">=</span> <span class="n">ShadowCastingMode</span><span class="p">.</span><span class="n">On</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">receiveShadows</span> <span class="p">=</span> <span class="kc">true</span><span class="p">,</span> <span class="kt">int</span> <span class="n">layer</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="n">Camera</span> <span class="n">camera</span> <span class="p">=</span> <span class="kc">null</span><span class="p">,</span> <span class="n">LightProbeUsage</span> <span class="n">lightProbeUsage</span> <span class="p">=</span> <span class="n">LightProbeUsage</span><span class="p">.</span><span class="n">BlendProbes</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="n">LightProbeProxyVolume</span> <span class="n">lightProbeProxyVolume</span> <span class="p">=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></div><p>Most of the parameters are self-explanatory. The <code>ComputeBuffer bufferWithArgs</code> is the most important one. It is a buffer that contains the arguments for the draw call. This has to be exacly a 5 elements long int array.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">int</span><span class="p">[]</span> <span class="n">args</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="m">5</span><span class="p">]</span> <span class="p">{</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">};</span>
</span></span></code></pre></div><p>The five arguments that we are going to fill inside this int array are:</p>
<ol>
<li>the number of instances</li>
<li>the number of instances to draw</li>
<li>the start instance location</li>
<li>the base vertex location</li>
<li>the start index location</li>
</ol>
<p>With the knowledge above, we can create a simple script to draw a single mesh with GPU instancing.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">BillboardGrassRenderer</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Mesh</span> <span class="n">mesh</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">subMeshIndex</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">instanceCount</span> <span class="p">=</span> <span class="m">1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Vector3</span> <span class="n">dimension</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">density</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Material</span> <span class="n">m_Material</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">MaterialPropertyBlock</span> <span class="n">m_PropertyBlock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MaterialPropertyBlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ComputeBuffer</span> <span class="n">m_ArgsBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">uint</span><span class="p">[]</span> <span class="n">m_Args</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[</span><span class="m">5</span><span class="p">]</span> <span class="p">{</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_ArgsBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">m_Args</span><span class="p">.</span><span class="n">Length</span> <span class="p">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="n">ComputeBufferType</span><span class="p">.</span><span class="n">IndirectArguments</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_Args</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">mesh</span><span class="p">.</span><span class="n">GetIndexCount</span><span class="p">(</span><span class="n">subMeshIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_Args</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">mesh</span><span class="p">.</span><span class="n">GetIndexStart</span><span class="p">(</span><span class="n">subMeshIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_Args</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">mesh</span><span class="p">.</span><span class="n">GetBaseVertex</span><span class="p">(</span><span class="n">subMeshIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_Args</span><span class="p">[</span><span class="m">4</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_ArgsBuffer</span><span class="p">.</span><span class="n">SetData</span><span class="p">(</span><span class="n">m_Args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">dimensionAndDensity</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">(</span><span class="n">dimension</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">dimension</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">density</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">density</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_PropertyBlock</span><span class="p">.</span><span class="n">SetVector</span><span class="p">(</span><span class="n">DimensionAndDensityPropertyID</span><span class="p">,</span> <span class="n">dimensionAndDensity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_Material</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Material</span><span class="p">(</span><span class="n">Shader</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="s">&#34;Universal Render Pipeline/Lit&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">Update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Graphics</span><span class="p">.</span><span class="n">DrawMeshInstancedIndirect</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">subMeshIndex</span><span class="p">,</span> <span class="n">m_Material</span><span class="p">,</span> <span class="k">new</span> <span class="n">Bounds</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">dimension</span><span class="p">),</span> <span class="n">m_ArgsBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">m_PropertyBlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">OnDisable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">m_ArgsBuffer</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_ArgsBuffer</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_argsBuffer</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="material">Material</h2>
<p>As you probably noticed in the script, the grass material is currently using URP/Lit as its shader. As we didn&rsquo;t compute the grass positions anywhere, the grass will be drawn at the origin. We can fix this in two ways:</p>
<ol>
<li>Compute position info in the shader</li>
<li>Use a compute shader to calculate the positions, and a compute buffer to store the positions info and pass it to the shader.</li>
</ol>
<p>The difference between the two methods is that the first method is more efficient as there&rsquo;s no need to pass the information around between CPU and GPU , but the second method is more flexible. We will use the first method in this tutorial.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="n">Shader</span> <span class="s">&#34;Hidden/XiheRendering/BillboardGrassUnlit&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Properties</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_MainTex</span> <span class="p">(</span><span class="s">&#34;Albedo (RGB)&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">SubShader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Cull</span> <span class="n">Off</span>
</span></span><span class="line"><span class="cl">        <span class="n">Zwrite</span> <span class="n">On</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Pass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Name</span> <span class="s">&#34;BillboardGrassForward&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Tags</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;LightMode&#34;</span> <span class="o">=</span> <span class="s">&#34;UniversalForward&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">HLSLPROGRAM</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span> <span class="n">Vertex</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">Fragment</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">include</span> <span class="s">&#34;Packages/com.unity.render-pipelines.core/ShaderLibrary/Color.hlsl&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">include</span> <span class="s">&#34;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_MainTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">Attributes</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">Varyings</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">positionHCS</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Varyings</span> <span class="n">Vertex</span><span class="p">(</span><span class="n">Attributes</span> <span class="n">IN</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">instanceID</span> <span class="o">:</span> <span class="nd">SV_InstanceID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">Varyings</span> <span class="n">o</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">o</span><span class="p">.</span><span class="n">positionHCS</span> <span class="o">=</span> <span class="n">TransformObjectToHClip</span><span class="p">(</span><span class="n">IN</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">float4</span> <span class="n">Fragment</span><span class="p">(</span><span class="n">Varyings</span> <span class="n">IN</span><span class="p">)</span> <span class="o">:</span> <span class="nd">SV_Target</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">albedo</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">sampler_MainTex</span><span class="p">,</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nb">clip</span><span class="p">(</span><span class="n">albedo</span><span class="p">.</span><span class="n">a</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">albedo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ENDHLSL</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="gpu-instancing-keywords-and-macros">GPU Instancing Keywords and Macros</h3>
<p>First thing is first, in order to let the shader support GPU instancing, we need to add <code>#pragma multi_compile_instancing</code> to the shader. This will tell the shader to generate multiple shader variants for each instance.</p>
<p>All keywords and macros can be found here: <a href="https://docs.unity3d.com/Manual/gpu-instancing-shader.html">Creating shaders that support GPU instancing</a>.</p>
<h3 id="material-property">Material Property</h3>
<p>In this basic shader, we first declare the <code>_Dimension</code> property inside the <code>UNITY_INSTANCING_BUFFER_START</code> and <code>UNITY_INSTANCING_BUFFER_END</code> macros.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="n">UNITY_INSTANCING_BUFFER_START</span><span class="p">(</span><span class="n">Props</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float4</span><span class="p">,</span> <span class="n">_Dimension</span><span class="p">)</span> <span class="c1">//x: dimensionX, y: dimensionZ, z: densityX, w: densityZ</span>
</span></span><span class="line"><span class="cl"><span class="n">UNITY_INSTANCING_BUFFER_END</span><span class="p">(</span><span class="n">Props</span><span class="p">)</span>
</span></span></code></pre></div><p><code>UNITY_INSTANCING_BUFFER</code> is a per-instance type of CBUFFER which will receive values from MaterialPropertyBlock from C# side.</p>
<p>We will use this property to calculate a 2D(XZ) position offset(similar to DispatchThreadID) of the grass instance. Let&rsquo;s first draw a grass instance every 1 meter on the x-axis and 1 meter on the z-axis. We can then calculate the offset distance for each instance on the x and z axis using the instance ID and the <code>_Dimension</code> property.</p>
<ul>
<li>_Dimension.x: dimension of the grass bounding volume on the x-axis</li>
<li>_Dimension.y: dimension of the grass bounding volume on the z-axis</li>
<li>_Dimension.z: density of the grass per meter on the x-axis</li>
<li>_Dimension.w: density of the grass per meter on the z-axis</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="c1">//actual number of instances allowed on z-axis</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">dimensionZ</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="n">_Dimension</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">offsetX</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="n">instanceID</span> <span class="o">/</span> <span class="n">dimensionZ</span><span class="p">)</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">offsetZ</span> <span class="o">=</span> <span class="n">instanceID</span> <span class="o">%</span> <span class="n">dimensionZ</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span></code></pre></div><h3 id="local-position-offset">Local Position Offset</h3>
<p>Now we got offset distance for each instance on the x and z axis, add the offset to the origin position and subtract half of the bounding volume to get a local position from the left, backward corner of the bounding volume:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="kt">float3</span> <span class="n">localPositionOffset</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="n">localPosition</span> <span class="o">-</span> <span class="kt">float3</span><span class="p">(</span><span class="n">_Dimension</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="mo">0</span><span class="p">,</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="kt">float3</span><span class="p">(</span><span class="n">offsetX</span><span class="p">,</span> <span class="mo">0</span><span class="p">,</span> <span class="n">offsetZ</span><span class="p">);</span>
</span></span></code></pre></div><h3 id="noise-texture-uv">Noise Texture UV</h3>
<p>We can also calculate the normalized offset to get a grass-bounding-box-space UV for sampling scrolling noise textures later, x-axis is the offsetX, y-axis is the offsetZ. We can use this UV to sample the noise texture later to add some wind effect to the grass.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="c1">//normalized instance ID in 2D space</span>
</span></span><span class="line"><span class="cl"><span class="kt">float2</span> <span class="n">instanceID2D01</span> <span class="o">=</span> <span class="kt">float2</span><span class="p">(</span><span class="n">offsetX</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">offsetZ</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span></code></pre></div><h3 id="static-gpu-instancing-grass-shader">Static GPU Instancing Grass Shader</h3>
<p>Putting all the pieces together, we get the following shader:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="n">Shader</span> <span class="s">&#34;Hidden/XiheRendering/BillboardGrassUnlit&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Properties</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_MainTex</span> <span class="p">(</span><span class="s">&#34;Albedo (RGB)&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">SubShader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Cull</span> <span class="n">Off</span>
</span></span><span class="line"><span class="cl">        <span class="n">Zwrite</span> <span class="n">On</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Pass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Name</span> <span class="s">&#34;BillboardGrassForward&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Tags</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;LightMode&#34;</span> <span class="o">=</span> <span class="s">&#34;UniversalForward&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">HLSLPROGRAM</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span> <span class="n">Vertex</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">Fragment</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">pragma</span> <span class="n">target</span> <span class="mf">4.5</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_instancing</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">include</span> <span class="s">&#34;Packages/com.unity.render-pipelines.core/ShaderLibrary/Color.hlsl&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">include</span> <span class="s">&#34;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">UNITY_INSTANCING_BUFFER_START</span><span class="p">(</span><span class="n">Props</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float4</span><span class="p">,</span> <span class="n">_Dimension</span><span class="p">)</span> <span class="c1">//x: dimensionX, y: dimensionZ, z: densityX, w: densityZ</span>
</span></span><span class="line"><span class="cl">            <span class="n">UNITY_INSTANCING_BUFFER_END</span><span class="p">(</span><span class="n">Props</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_MainTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">Attributes</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">Varyings</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">positionHCS</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Varyings</span> <span class="n">Vertex</span><span class="p">(</span><span class="n">Attributes</span> <span class="n">IN</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">instanceID</span> <span class="o">:</span> <span class="nd">SV_InstanceID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float</span> <span class="n">dimensionZ</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="n">_Dimension</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">w</span><span class="p">);</span> <span class="c1">//actual number of instances allowed on z-axis</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float</span> <span class="n">offsetX</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="n">instanceID</span> <span class="o">/</span> <span class="n">dimensionZ</span><span class="p">)</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float</span> <span class="n">offsetZ</span> <span class="o">=</span> <span class="n">instanceID</span> <span class="o">%</span> <span class="n">dimensionZ</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="kt">float3</span> <span class="n">localPosition</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float2</span> <span class="n">instanceID2D01</span> <span class="o">=</span> <span class="kt">float2</span><span class="p">(</span><span class="n">offsetX</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">offsetZ</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">y</span><span class="p">);</span><span class="c1">//no use for now, use this to sample noise later </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="kt">float3</span> <span class="n">localPositionOffset</span> <span class="o">=</span> <span class="n">localPosition</span> <span class="o">-</span> <span class="kt">float3</span><span class="p">(</span><span class="n">_Dimension</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="mo">0</span><span class="p">,</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="kt">float3</span><span class="p">(</span><span class="n">offsetX</span><span class="p">,</span> <span class="mo">0</span><span class="p">,</span> <span class="n">offsetZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">Varyings</span> <span class="n">o</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">o</span><span class="p">.</span><span class="n">positionHCS</span> <span class="o">=</span> <span class="n">TransformObjectToHClip</span><span class="p">(</span><span class="n">localPositionOffset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">float4</span> <span class="n">Fragment</span><span class="p">(</span><span class="n">Varyings</span> <span class="n">IN</span><span class="p">)</span> <span class="o">:</span> <span class="nd">SV_Target</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">albedo</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">sampler_MainTex</span><span class="p">,</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nb">clip</span><span class="p">(</span><span class="n">albedo</span><span class="p">.</span><span class="n">a</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">albedo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ENDHLSL</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="noise">Noise</h2>
<p>Now if you click on Play button again, you will see a grid of grass instances, all sitting peacefully, no animation, no position offset, not fit for our goal.</p>
<h3 id="control-map">Control Map</h3>
<p>We can add multiple noise texture to randomize and control all the grass properties, for example, position, desity, scale, and height.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="n">_PositionTex</span><span class="p">(</span><span class="s">&#34;Position Offset&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">_DensityTex</span><span class="p">(</span><span class="s">&#34;Density&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">_ScaleTex</span><span class="p">(</span><span class="s">&#34;Scale&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">_HeightTex</span><span class="p">(</span><span class="s">&#34;Height&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span>
</span></span></code></pre></div><p>But as you probably noticed, most of the properties only require a float value, which means each of them is only going to take one channel to store the data. We can store all the one-channel data into RGBA respectively in a single texture called <code>_ControlTex</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="n">_ControlTex</span><span class="p">(</span><span class="s">&#34;Control&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span><span class="c1">//R: Position Offset, G: Density, B: Scale, A: Height</span>
</span></span></code></pre></div><p>To use the texture, we can use the normalized 2D instance ID we calculated before as the UV to sample the texture:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="kt">float4</span> <span class="n">control</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D_LOD</span><span class="p">(</span><span class="n">_ControlTex</span><span class="p">,</span> <span class="n">sampler_ControlTex</span><span class="p">,</span> <span class="n">instanceID2D01</span><span class="p">,</span> <span class="mo">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//control.r: position offset</span>
</span></span><span class="line"><span class="cl"><span class="c1">//control.g: density</span>
</span></span><span class="line"><span class="cl"><span class="c1">//control.b: scale</span>
</span></span><span class="line"><span class="cl"><span class="c1">//control.a: height</span>
</span></span></code></pre></div><p>Now we got a float4 control value for that vertex instance, we can then use it to control the position, density, scale, and height of the grass instance later.</p>
<h3 id="wind-map">Wind Map</h3>
<p>For wind effect, we can use another scrolling continuous noise texture to simulate the wind effect, four channels of the texture can be used to control the wind effect in different directions and the scale if the grass instance.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="n">_NoiseTex</span> <span class="p">(</span><span class="s">&#34;Noise (RGBA)&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span><span class="c1">//R: PosX, G: PosY, B: PosZ, A: Scale</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="n">UNITY_INSTANCING_BUFFER_START</span><span class="p">(</span><span class="n">Props</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float4</span><span class="p">,</span> <span class="n">_SwingScale</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float</span><span class="p">,</span> <span class="n">_Speed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">UNITY_DEFINE_INSTANCED_END</span><span class="p">(</span><span class="n">Props</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="kt">float4</span> <span class="nb">noise</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D_LOD</span><span class="p">(</span><span class="n">_NoiseTex</span><span class="p">,</span> <span class="n">sampler_NoiseTex</span><span class="p">,</span> <span class="n">instanceID2D01</span> <span class="o">+</span> <span class="n">_Time</span><span class="p">.</span><span class="n">xy</span> <span class="o">*</span> <span class="n">_Speed</span><span class="p">,</span> <span class="mo">0</span><span class="p">);</span>
</span></span></code></pre></div><p>Now we got another float4 noise value for wind.</p>
<h2 id="final">Final</h2>
<h3 id="shader">Shader</h3>
<p>Putting all the pieces together, we get the final shader:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hlsl" data-lang="hlsl"><span class="line"><span class="cl"><span class="n">Shader</span> <span class="s">&#34;Hidden/XiheRendering/BillboardGrassUnlit&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Properties</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_MainTex</span> <span class="p">(</span><span class="s">&#34;Albedo (RGB)&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">_ControlTex</span> <span class="p">(</span><span class="s">&#34;Control (RGBA)&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span><span class="c1">//R: Position Offset, G: Density, B: Scale, A: Height</span>
</span></span><span class="line"><span class="cl">        <span class="n">_NoiseTex</span> <span class="p">(</span><span class="s">&#34;Noise (RGBA)&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;white&#34;</span> <span class="p">{}</span><span class="c1">//R: PosX, G: PosY, B: PosZ, A: Scale</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">SubShader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Cull</span> <span class="n">Off</span>
</span></span><span class="line"><span class="cl">        <span class="n">Zwrite</span> <span class="n">On</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Pass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Name</span> <span class="s">&#34;BillboardGrassForward&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Tags</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;LightMode&#34;</span> <span class="o">=</span> <span class="s">&#34;UniversalForward&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Blend</span> <span class="n">SrcAlpha</span> <span class="n">OneMinusSrcAlpha</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">HLSLPROGRAM</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span> <span class="n">Vertex</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">Fragment</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">pragma</span> <span class="n">target</span> <span class="mf">4.5</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">pragma</span> <span class="n">multi_compile_instancing</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">include</span> <span class="s">&#34;Packages/com.unity.render-pipelines.core/ShaderLibrary/Color.hlsl&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="err">#</span><span class="n">include</span> <span class="s">&#34;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">UNITY_INSTANCING_BUFFER_START</span><span class="p">(</span><span class="n">Props</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float4</span><span class="p">,</span> <span class="n">_Dimension</span><span class="p">)</span> <span class="c1">//x: dimensionX, y: dimensionZ, z: densityX, w: densityZ</span>
</span></span><span class="line"><span class="cl">                <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float</span><span class="p">,</span> <span class="n">_DimensionY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float4</span><span class="p">,</span> <span class="n">_ControlNoiseScale</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float4</span><span class="p">,</span> <span class="n">_SwingScale</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">UNITY_DEFINE_INSTANCED_PROP</span><span class="p">(</span><span class="kt">float</span><span class="p">,</span> <span class="n">_Speed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">UNITY_INSTANCING_BUFFER_END</span><span class="p">(</span><span class="n">Props</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_MainTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//R: PosX, G: PosZ, B: Scale, A: Height</span>
</span></span><span class="line"><span class="cl">            <span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_ControlTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_ControlTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//R: PosX, G: PosY, B: PosZ, A: Scale</span>
</span></span><span class="line"><span class="cl">            <span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_NoiseTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_NoiseTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">Attributes</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">Varyings</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">positionHCS</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Varyings</span> <span class="n">Vertex</span><span class="p">(</span><span class="n">Attributes</span> <span class="n">IN</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">instanceID</span> <span class="o">:</span> <span class="nd">SV_InstanceID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float</span> <span class="n">dimensionZ</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="n">_Dimension</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">w</span><span class="p">);</span> <span class="c1">//actual number of instances allowed on z-axis</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float</span> <span class="n">offsetX</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="n">instanceID</span> <span class="o">/</span> <span class="n">dimensionZ</span><span class="p">)</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float</span> <span class="n">offsetZ</span> <span class="o">=</span> <span class="n">instanceID</span> <span class="o">%</span> <span class="n">dimensionZ</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="kt">float3</span> <span class="n">localPosition</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// float2 instanceID2D01 = float2(offsetX / _Dimension.x, offsetZ / _Dimension.y);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float2</span> <span class="n">instanceID2D01</span> <span class="o">=</span> <span class="kt">float2</span><span class="p">(</span><span class="n">offsetX</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">offsetZ</span> <span class="o">/</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">//R: Pos Noise, G: Scale Noise, B: Density, A: Height</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">control</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D_LOD</span><span class="p">(</span><span class="n">_ControlTex</span><span class="p">,</span> <span class="n">sampler_ControlTex</span><span class="p">,</span> <span class="n">instanceID2D01</span><span class="p">,</span> <span class="mo">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="nb">noise</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D_LOD</span><span class="p">(</span><span class="n">_NoiseTex</span><span class="p">,</span> <span class="n">sampler_NoiseTex</span><span class="p">,</span> <span class="n">instanceID2D01</span><span class="o">+</span><span class="n">_Time</span><span class="p">.</span><span class="n">xy</span><span class="o">*</span><span class="n">_Speed</span><span class="p">,</span> <span class="mo">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">localPosition</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="nb">lerp</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">noise</span><span class="p">.</span><span class="n">r</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">_SwingScale</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">localPosition</span><span class="p">.</span><span class="n">z</span> <span class="o">+=</span> <span class="nb">lerp</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">noise</span><span class="p">.</span><span class="n">g</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">_SwingScale</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">localPosition</span> <span class="o">*=</span> <span class="p">(</span><span class="nb">noise</span><span class="p">.</span><span class="n">a</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">_SwingScale</span><span class="p">.</span><span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">localPosition</span> <span class="o">*=</span> <span class="nb">step</span><span class="p">(.</span><span class="mi">5</span><span class="p">,</span> <span class="n">control</span><span class="p">.</span><span class="n">g</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">control</span><span class="p">.</span><span class="n">b</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">_ControlNoiseScale</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">localPosition</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="n">control</span><span class="p">.</span><span class="n">r</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">_ControlNoiseScale</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">localPosition</span><span class="p">.</span><span class="n">z</span> <span class="o">+=</span> <span class="p">(</span><span class="n">control</span><span class="p">.</span><span class="n">r</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">_ControlNoiseScale</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">localPosition</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="o">-</span><span class="n">_DimensionY</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">control</span><span class="p">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">_DimensionY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">//calculate world position                </span>
</span></span><span class="line"><span class="cl">                <span class="kt">float3</span> <span class="n">worldPosition</span> <span class="o">=</span> <span class="n">localPosition</span> <span class="o">-</span> <span class="kt">float3</span><span class="p">(</span><span class="n">_Dimension</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="mo">0</span><span class="p">,</span> <span class="n">_Dimension</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="kt">float3</span><span class="p">(</span><span class="n">offsetX</span><span class="p">,</span> <span class="mo">0</span><span class="p">,</span> <span class="n">offsetZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">Varyings</span> <span class="n">o</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">o</span><span class="p">.</span><span class="n">positionHCS</span> <span class="o">=</span> <span class="n">TransformObjectToHClip</span><span class="p">(</span><span class="n">worldPosition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">float4</span> <span class="n">Fragment</span><span class="p">(</span><span class="n">Varyings</span> <span class="n">IN</span><span class="p">)</span> <span class="o">:</span> <span class="nd">SV_Target</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">albedo</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">sampler_MainTex</span><span class="p">,</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nb">clip</span><span class="p">(</span><span class="n">albedo</span><span class="p">.</span><span class="n">a</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="kt">float4</span> <span class="n">output</span> <span class="o">=</span> <span class="n">albedo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">ENDHLSL</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="renderer">Renderer</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.Rendering</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.Serialization</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">XiheRendering.Procedural.BillboardGrass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">BillboardGrassRenderer</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Mesh</span> <span class="n">mesh</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="n">subMeshIndex</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// material</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Texture2D</span> <span class="n">colorMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Texture2D</span> <span class="n">controlMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Texture2D</span> <span class="n">noiseMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="n">layer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ShadowCastingMode</span> <span class="n">castShadows</span> <span class="p">=</span> <span class="n">ShadowCastingMode</span><span class="p">.</span><span class="n">On</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">bool</span> <span class="n">receiveShadows</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// instancing</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Vector3</span> <span class="n">dimension</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">density</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Vector4</span> <span class="n">controlNoiseScale</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Vector3</span> <span class="n">swingScale</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">float</span> <span class="n">scaleSwingScale</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">float</span> <span class="n">swingSpeed</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">bool</span> <span class="n">renderInSceneCamera</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Material</span> <span class="n">m_Material</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Vector2</span> <span class="n">m_CachedDensity</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Vector3</span> <span class="n">m_CachedDimension</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Vector4</span> <span class="n">m_CachedControlNoiseScale</span> <span class="p">=</span> <span class="n">Vector4</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Vector3</span> <span class="n">m_CachedSwingScale</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">float</span> <span class="n">m_CachedScaleSwingScale</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">float</span> <span class="n">m_CachedSwingSpeed</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Texture2D</span> <span class="n">m_CachedColorMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Texture2D</span> <span class="n">m_CachedControlMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Texture2D</span> <span class="n">m_CachedNoiseMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">ComputeBuffer</span> <span class="n">m_ArgsBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">readonly</span> <span class="kt">uint</span><span class="p">[]</span> <span class="n">m_Args</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[</span><span class="m">5</span><span class="p">]</span> <span class="p">{</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">MaterialPropertyBlock</span> <span class="n">m_PropertyBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">DimensionAndDensityPropertyID</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="n">PropertyToID</span><span class="p">(</span><span class="s">&#34;_Dimension&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">DimensionYPropertyID</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="n">PropertyToID</span><span class="p">(</span><span class="s">&#34;_DimensionY&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">ColorMapPropertyID</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="n">PropertyToID</span><span class="p">(</span><span class="s">&#34;_MainTex&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">ControlMapPropertyID</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="n">PropertyToID</span><span class="p">(</span><span class="s">&#34;_ControlTex&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">NoiseMapPropertyID</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="n">PropertyToID</span><span class="p">(</span><span class="s">&#34;_NoiseTex&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">SwingSpeedPropertyID</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="n">PropertyToID</span><span class="p">(</span><span class="s">&#34;_Speed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">ControlNoiseScale</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="n">PropertyToID</span><span class="p">(</span><span class="s">&#34;_ControlNoiseScale&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">SwingScale</span> <span class="p">=</span> <span class="n">Shader</span><span class="p">.</span><span class="n">PropertyToID</span><span class="p">(</span><span class="s">&#34;_SwingScale&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_ArgsBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">m_Args</span><span class="p">.</span><span class="n">Length</span> <span class="p">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="n">ComputeBufferType</span><span class="p">.</span><span class="n">IndirectArguments</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_PropertyBlock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MaterialPropertyBlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">UpdateBuffers</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">Update</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Update starting position buffer</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">m_CachedDensity</span> <span class="p">!=</span> <span class="n">density</span> <span class="p">||</span> <span class="n">m_CachedDimension</span> <span class="p">!=</span> <span class="n">dimension</span> <span class="p">||</span> <span class="n">m_CachedControlNoiseScale</span> <span class="p">!=</span> <span class="n">controlNoiseScale</span> <span class="p">||</span> <span class="n">m_CachedSwingScale</span> <span class="p">!=</span> <span class="n">swingScale</span> <span class="p">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">Math</span><span class="p">.</span><span class="n">Abs</span><span class="p">(</span><span class="n">m_CachedScaleSwingScale</span> <span class="p">-</span> <span class="n">scaleSwingScale</span><span class="p">)</span> <span class="p">&gt;</span> <span class="kt">float</span><span class="p">.</span><span class="n">Epsilon</span> <span class="p">||</span> <span class="n">colorMap</span> <span class="p">!=</span> <span class="n">m_CachedColorMap</span> <span class="p">||</span> <span class="n">controlMap</span> <span class="p">!=</span> <span class="n">m_CachedControlMap</span> <span class="p">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">noiseMap</span> <span class="p">!=</span> <span class="n">m_CachedNoiseMap</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">UpdateBuffers</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Render</span>
</span></span><span class="line"><span class="cl">            <span class="n">Graphics</span><span class="p">.</span><span class="n">DrawMeshInstancedIndirect</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">subMeshIndex</span><span class="p">,</span> <span class="n">m_Material</span><span class="p">,</span> <span class="k">new</span> <span class="n">Bounds</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">dimension</span><span class="p">),</span> <span class="n">m_ArgsBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">m_PropertyBlock</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">castShadows</span><span class="p">,</span> <span class="n">receiveShadows</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">renderInSceneCamera</span> <span class="p">?</span> <span class="kc">null</span> <span class="p">:</span> <span class="n">Camera</span><span class="p">.</span><span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">UpdateBuffers</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">mesh</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">m_Args</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">m_Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">m_Args</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="n">m_Args</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">m_PropertyBlock</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">Debug</span><span class="p">.</span><span class="n">LogWarning</span><span class="p">(</span><span class="s">&#34;You forgot to assign a mesh to GPU grass generator&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Ensure submesh index is in range</span>
</span></span><span class="line"><span class="cl">            <span class="n">subMeshIndex</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Clamp</span><span class="p">(</span><span class="n">subMeshIndex</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">mesh</span><span class="p">.</span><span class="n">subMeshCount</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">density</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">density</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">density</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">dimension</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">dimension</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">dimension</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">dimension</span><span class="p">.</span><span class="n">z</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//set properties</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">m_Material</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">m_Material</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Material</span><span class="p">(</span><span class="n">Shader</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="s">&#34;Hidden/XiheRendering/BillboardGrassUnlit&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">dimensionAndDensity</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">(</span><span class="n">dimension</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">dimension</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">density</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">density</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_PropertyBlock</span><span class="p">.</span><span class="n">SetVector</span><span class="p">(</span><span class="n">DimensionAndDensityPropertyID</span><span class="p">,</span> <span class="n">dimensionAndDensity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_PropertyBlock</span><span class="p">.</span><span class="n">SetFloat</span><span class="p">(</span><span class="n">DimensionYPropertyID</span><span class="p">,</span> <span class="n">dimension</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_PropertyBlock</span><span class="p">.</span><span class="n">SetTexture</span><span class="p">(</span><span class="n">ColorMapPropertyID</span><span class="p">,</span> <span class="n">colorMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_PropertyBlock</span><span class="p">.</span><span class="n">SetTexture</span><span class="p">(</span><span class="n">ControlMapPropertyID</span><span class="p">,</span> <span class="n">controlMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_PropertyBlock</span><span class="p">.</span><span class="n">SetTexture</span><span class="p">(</span><span class="n">NoiseMapPropertyID</span><span class="p">,</span> <span class="n">noiseMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_PropertyBlock</span><span class="p">.</span><span class="n">SetFloat</span><span class="p">(</span><span class="n">SwingSpeedPropertyID</span><span class="p">,</span> <span class="n">swingSpeed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_PropertyBlock</span><span class="p">.</span><span class="n">SetVector</span><span class="p">(</span><span class="n">ControlNoiseScale</span><span class="p">,</span> <span class="n">controlNoiseScale</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_PropertyBlock</span><span class="p">.</span><span class="n">SetVector</span><span class="p">(</span><span class="n">SwingScale</span><span class="p">,</span> <span class="k">new</span> <span class="n">Vector4</span><span class="p">(</span><span class="n">swingScale</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">swingScale</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">swingScale</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">scaleSwingScale</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Args</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// index count per instance,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// instance count,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// start index location,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// base vertex location,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// start instance location.</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_Args</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">mesh</span><span class="p">.</span><span class="n">GetIndexCount</span><span class="p">(</span><span class="n">subMeshIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">Mathf</span><span class="p">.</span><span class="n">FloorToInt</span><span class="p">(</span><span class="n">density</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">dimension</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">density</span><span class="p">.</span><span class="n">y</span> <span class="p">*</span> <span class="n">dimension</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_Args</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">mesh</span><span class="p">.</span><span class="n">GetIndexStart</span><span class="p">(</span><span class="n">subMeshIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_Args</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">mesh</span><span class="p">.</span><span class="n">GetBaseVertex</span><span class="p">(</span><span class="n">subMeshIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">m_ArgsBuffer</span><span class="p">.</span><span class="n">SetData</span><span class="p">(</span><span class="n">m_Args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">m_CachedDensity</span> <span class="p">=</span> <span class="n">density</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_CachedDimension</span> <span class="p">=</span> <span class="n">dimension</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">OnDisable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">m_ArgsBuffer</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">m_ArgsBuffer</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_ArgsBuffer</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if</span> <span class="n">UNITY_EDITOR</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">OnDrawGizmos</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//draw bounding box</span>
</span></span><span class="line"><span class="cl">            <span class="n">Gizmos</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Gizmos</span><span class="p">.</span><span class="n">DrawWireCube</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">dimension</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="next-steps">Next Steps</h3>
<p>As you can see, we have created a GPU instancing grass system&hellip;for flat surfaces without any obstacles&hellip;, which isn&rsquo;t very useful. The good thing is that we have implemented the control map and noise map, all that&rsquo;s left is a tool to generate those maps based on the real environment.</p>
<p>In the next post, we will create an tool based on untiy&rsquo;s EditorWindow to bake the control map and noise map!</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://www.yaotian-huang.com/en/tags/unity/">Unity</a></li>
      <li><a href="https://www.yaotian-huang.com/en/tags/shader/">Shader</a></li>
      <li><a href="https://www.yaotian-huang.com/en/tags/gpu-instancing/">GPU Instancing</a></li>
      <li><a href="https://www.yaotian-huang.com/en/tags/grass/">Grass</a></li>
      <li><a href="https://www.yaotian-huang.com/en/tags/urp/">URP</a></li>
    </ul>

<div class="share-buttons">

    <a target="_blank" rel="noopener noreferrer" aria-label="share Create Stylized GPU Instancing Billboard Grass Without Creating Position Buffer in URP on linkedin"
        href="https://www.linkedin.com/in/heycharlola/">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span> <del>Life 1%</del></span>
      
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
