<!DOCTYPE html>
<html lang="jp" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Recreating the Rain Drop Effect in The Legend of Zelda: TOTK | ポートフォリオ</title>
<meta name="keywords" content="Unity, Shader, Compute Shader, Render Feature, Post Processing, URP" />
<meta name="description" content="Environment Unity 2021.3.16f1
Universal Render Pipeline 12.0.0
Introduction I recently finished The Legend of Zelda: Tears of the Kingdom. To me as an indie game developer, it felt like a text book of open world game design. I had a lot of fun playing it and I learned a lot from it.
One of the things I noticed is the rain drop effect that react to the uppper edges of the scene.">
<meta name="author" content="黃 堯天">
<link rel="canonical" href="https://www.yaotian-huang.com/jp/ta/recreating-the-rain-drop-effect-in-the-legend-of-zelda-totk/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7bfe087ae72df31787ec7a1360dd05ee246a179b51cf7a30a904b39d7f813b69.css" integrity="sha256-e/4Ieuct8xeH7HoTYN0F7iRqF5tRz3owqQSznX&#43;BO2k=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.30d2332871da51f600f574811c17751e6c862577d450b624f86e2bc8a6e31221.js" integrity="sha256-MNIzKHHaUfYA9XSBHBd1HmyGJXfUULYk&#43;G4ryKbjEiE="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://www.yaotian-huang.com/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.yaotian-huang.com/images/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.yaotian-huang.com/images/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://www.yaotian-huang.com/images/apple-touch-icon.png">
<link rel="mask-icon" href="https://www.yaotian-huang.com/images/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://www.yaotian-huang.com/en/ta/recreating-the-rain-drop-effect-in-the-legend-of-zelda-totk/" />
<link rel="alternate" hreflang="jp" href="https://www.yaotian-huang.com/jp/ta/recreating-the-rain-drop-effect-in-the-legend-of-zelda-totk/" />
<link rel="alternate" hreflang="cn" href="https://www.yaotian-huang.com/cn/ta/recreating-the-rain-drop-effect-in-the-legend-of-zelda-totk/" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.yaotian-huang.com/jp/" accesskey="h" title="ポートフォリオ (Alt + H)">ポートフォリオ</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://www.yaotian-huang.com/en/ta/recreating-the-rain-drop-effect-in-the-legend-of-zelda-totk/" title="EN"
                            aria-label="EN">EN</a>
                    </li>
                    <li>
                        <a href="https://www.yaotian-huang.com/cn/ta/recreating-the-rain-drop-effect-in-the-legend-of-zelda-totk/" title="CN"
                            aria-label="CN">CN</a>
                    </li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home"><span>Home</span></a>
            </li>
            <li>
                <a href="https://www.yaotian-huang.com/jp/projects/" title="プロジェクト">
                    <span>プロジェクト</span>
                </a>
            </li>
            <li>
                <a href="https://www.yaotian-huang.com/jp/ta/" title="テクニカルアート">
                    <span>テクニカルアート</span>
                </a>
            </li>
            <li>
                <a href="https://www.yaotian-huang.com/jp/code/" title="プログラミング">
                    <span>プログラミング</span>
                </a>
            </li>
            <li>
                <a href="https://www.yaotian-huang.com/jp/art/" title="アート">
                    <span>アート</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://www.yaotian-huang.com/jp/">Home</a>&nbsp;»&nbsp;<a href="https://www.yaotian-huang.com/jp/ta/">Technical Art</a></div>
    <h1 class="post-title">
      Recreating the Rain Drop Effect in The Legend of Zelda: TOTK
    </h1>
    <div class="post-meta"><span title='2023-05-23 23:50:10 -0400 -0400'>May 23, 2023</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;黃 堯天</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#environment" aria-label="Environment">Environment</a></li>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#demo" aria-label="Demo">Demo</a></li>
                <li>
                    <a href="#how-it-works" aria-label="How It Works">How It Works</a><ul>
                        
                <li>
                    <a href="#edge-detection" aria-label="Edge Detection">Edge Detection</a></li>
                <li>
                    <a href="#noise-map" aria-label="Noise Map">Noise Map</a></li></ul>
                </li>
                <li>
                    <a href="#implementation" aria-label="Implementation">Implementation</a><ul>
                        
                <li>
                    <a href="#strcutre-a-render-feature" aria-label="Strcutre a Render Feature">Strcutre a Render Feature</a></li>
                <li>
                    <a href="#create-a-render-pass" aria-label="Create a Render Pass">Create a Render Pass</a></li>
                <li>
                    <a href="#final-code" aria-label="Final Code">Final Code</a></li></ul>
                </li>
                <li>
                    <a href="#improvement" aria-label="Improvement">Improvement</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content">
  <h2 id="environment">Environment</h2>
<p>Unity 2021.3.16f1<br>
Universal Render Pipeline 12.0.0</p>
<h2 id="introduction">Introduction</h2>
<p>I recently finished <em>The Legend of Zelda: Tears of the Kingdom</em>. To me as an indie game developer, it felt like a text book of open world game design. I had a lot of fun playing it and I learned a lot from it.</p>
<p>One of the things I noticed is the rain drop effect that react to the uppper edges of the scene. It&rsquo;s a very subtle effect but it actually guided me through the thunder island where the player&rsquo;s visibility range was less than 1 meter. In the image below, you can see that the rain drops react to the edge of the mining cart rails, which tells the player that there is a path to continue the journey. I guess probably the game designer didn&rsquo;t intend to do this, but it&rsquo;s Nintendo, you never know.</p>
<figure><img src="life-saver.png"/>
</figure>

<p>This effect was one of the a few things I could rely on while exploring the island, so I decided to implement it in Unity as a render feature, just to show my appreciation to those little rain drops.</p>
<h2 id="demo">Demo</h2>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/1oAGbDdVZ7E" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h2 id="how-it-works">How It Works</h2>
<p>The effect basically composes of two parts: Edge detection with angle limitation and a fast scrolling noise map.</p>
<h3 id="edge-detection">Edge Detection</h3>
<p>From the image above, we can see that the effect is applied even in places that have no gradient such as the rails. Therefore, it has to be using the depth buffer. With that being clear, We just need to apply a sobel edge deteciton on the depth buffer and get a edge mask.</p>
<p>If you are not familar with Sobel Edge Detection. Here is a quick explanation. Sobel Edge Detection is a simple edge detection algorithm that uses two 3x3 kernels to calculate the gradient of the image.</p>
<p>Horizontal:</p>
<pre tabindex="0"><code>-1  0  1
-2  0  2
-1  0  1
</code></pre><p>Vertical:</p>
<pre tabindex="0"><code> 1  2  1
 0  0  0
-1 -2 -1
</code></pre><p>Apply the two kernels respectively on each pixel(x,y) in the depth texture(depth):</p>
<pre tabindex="0"><code>horizontal = depth[x-1,y-1] * -1 + depth[x,y-1] * 0 + depth[x+1,y-1] * 1
           + depth[x-1,y]   * -2 + depth[x,y]   * 0 + depth[x+1,y]   * 2
           + depth[x-1,y+1] * -1 + depth[x,y+1] * 0 + depth[x+1,y+1] * 1

vertical = depth[x-1,y-1] * -1 + depth[x,y-1] * -2 + depth[x+1,y-1] * -1
         + depth[x-1,y]   * 0 + depth[x,y]   * 0 + depth[x+1,y]   * 0
         + depth[x-1,y+1] * 1 + depth[x,y+1] * 2 + depth[x+1,y+1] * 1
</code></pre><p>Then we can calculate the magnitude of the gradient by taking the square root of the sum of the squares of the two gradients:</p>
<pre tabindex="0"><code>magnitude = sqrt(horizontal * horizontal + vertical * vertical)
</code></pre><p>The magnitude is the value we are looking for. It describes the color gradient between the pixel and its neighbors. The higher the value, the more likely it is an edge.</p>
<p>From here, we do need one more value to describe the &ldquo;direction&rdquo; of the gradient. If it doesn&rsquo;t make sense to you. Just think about the gradient as a vector, composed of the horizontal gradient value we calculated before and the vertical gradient value. We can calculate the angle between the gradient vector and the horizontal axis by taking the arctangent of the vertical gradient over the horizontal gradient.</p>
<pre tabindex="0"><code>angle = atan2(vertical, horizontal)
</code></pre><p>It gives us a value between -pi and pi, representing the angle of the vector in radian.</p>
<p>Now we have the magnitude and the angle of the gradient. We can use them to create a mask that only shows the edges we want, which are the edges that are facing up.</p>
<figure><img src="demo_mask.png"/>
</figure>

<h3 id="noise-map">Noise Map</h3>
<p>Congradulations to you and future me that forgot how I did this! for making it this far. Now we have the edge mask, we can just multiply a scrolling noise map on it to get the final mask.</p>
<p>After that, configure the settings as you like: thickness, sobel threshold, rain drop scale, drop speed, drop color, etc.</p>
<p>For noise map, I used a simple 2D perlin noise map that I generated from this website: <a href="http://kitfox.com/projects/perlinNoiseMaker/">http://kitfox.com/projects/perlinNoiseMaker/</a></p>
<figure><img src="noise_map.png"/>
</figure>

<h2 id="implementation">Implementation</h2>
<h3 id="strcutre-a-render-feature">Strcutre a Render Feature</h3>
<p>First thing is first, we need to figure out what are the main inputs of the compute shader.</p>
<ul>
<li>A noise texture.</li>
<li>A thickness float value to control the &ldquo;thickness&rdquo; of the rain drops edges.</li>
<li>A sobel threshold float value to control the threshold of the sobel edge detection.</li>
<li>A rain drop scale float value to control the threshold of the step function that applies on the noise map to essentially control the size/density of the rain drops.</li>
</ul>
<p>Other than these input values, we also need some parameters for the render feature to work.</p>
<ul>
<li>A compute shader to do the contain all the calculations.</li>
<li>A RenderPassEvent to tell the render feature when to execute the render pass.</li>
</ul>
<p>And to make it more debuggable:</p>
<ul>
<li>A UV scrolling speed float value to control the speed of the scrolling noise map</li>
<li>A switch boolean value to turn on/off the rain drop effect in Unity Scene Editor.</li>
</ul>
<p>Finally construct them into a Setting class inside a ScriptalbeRendererFeature. As always, you can name this class whatever you want. I named it ZeldaRainDropFeature.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.Rendering</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.Rendering.Universal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.Serialization</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ZeldaRainDropFeature</span> <span class="p">:</span> <span class="n">ScriptableRendererFeature</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [SerializeField]</span> <span class="kd">public</span> <span class="n">Settings</span> <span class="n">settings</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Settings</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Create</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_RenderPass</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RainDropRenderPass</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">renderPassEvent</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">renderPassEvent</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">AddRenderPasses</span><span class="p">(</span><span class="n">ScriptableRenderer</span> <span class="n">renderer</span><span class="p">,</span> <span class="k">ref</span> <span class="n">RenderingData</span> <span class="n">renderingData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">rainDropShader</span> <span class="p">!=</span> <span class="kc">null</span> <span class="p">&amp;&amp;</span> <span class="n">settings</span><span class="p">.</span><span class="n">rainDropShader</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">renderer</span><span class="p">.</span><span class="n">EnqueuePass</span><span class="p">(</span><span class="n">m_RenderPass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [System.Serializable]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">Settings</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ComputeShader</span> <span class="n">rainDropShader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Texture2D</span> <span class="n">noiseTex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Color</span> <span class="n">dropColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">white</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">        [Range(0, 20)]</span> <span class="kd">public</span> <span class="kt">int</span> <span class="n">thickness</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">        [Range(0f, 1f)]</span> <span class="kd">public</span> <span class="kt">float</span> <span class="n">sobelThreshold</span> <span class="p">=</span> <span class="m">0.166f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">        [Range(0f, 1f)]</span> <span class="kd">public</span> <span class="kt">float</span> <span class="n">rainDropScale</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">float</span> <span class="n">dropSpeed</span> <span class="p">=</span> <span class="m">100f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">RenderPassEvent</span> <span class="n">renderPassEvent</span> <span class="p">=</span> <span class="n">RenderPassEvent</span><span class="p">.</span><span class="n">AfterRenderingTransparents</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">bool</span> <span class="n">previewInSceneView</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="create-a-render-pass">Create a Render Pass</h3>
<p>Now we have the settings and a basic structure of the render feature. We can start to implement the render pass.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">private</span> <span class="k">class</span> <span class="nc">RainDropRenderPass</span> <span class="p">:</span> <span class="n">ScriptableRenderPass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Settings</span> <span class="n">m_Settings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">RenderTargetHandle</span> <span class="n">m_ResultTex</span><span class="p">;</span> <span class="c1">//camera color</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">RainDropRenderPass</span><span class="p">(</span><span class="n">Settings</span> <span class="n">settings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_Settings</span> <span class="p">=</span> <span class="n">settings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Configure</span><span class="p">(</span><span class="n">CommandBuffer</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">RenderTextureDescriptor</span> <span class="n">cameraTextureDescriptor</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">descriptor</span> <span class="p">=</span> <span class="n">cameraTextureDescriptor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">descriptor</span><span class="p">.</span><span class="n">colorFormat</span> <span class="p">=</span> <span class="n">RenderTextureFormat</span><span class="p">.</span><span class="n">ARGB32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">descriptor</span><span class="p">.</span><span class="n">enableRandomWrite</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">GetTemporaryRT</span><span class="p">(</span><span class="n">m_ResultTex</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Execute</span><span class="p">(</span><span class="n">ScriptableRenderContext</span> <span class="n">context</span><span class="p">,</span> <span class="k">ref</span> <span class="n">RenderingData</span> <span class="n">renderingData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(!</span><span class="n">m_Settings</span><span class="p">.</span><span class="n">previewInSceneView</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">renderingData</span><span class="p">.</span><span class="n">cameraData</span><span class="p">.</span><span class="n">isSceneViewCamera</span> <span class="p">||</span> <span class="n">renderingData</span><span class="p">.</span><span class="n">cameraData</span><span class="p">.</span><span class="n">isPreviewCamera</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">CommandBuffer</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">CommandBufferPool</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&#34;Screen Door Transparency&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//cache color target</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">cam</span> <span class="p">=</span> <span class="n">renderingData</span><span class="p">.</span><span class="n">cameraData</span><span class="p">.</span><span class="n">renderer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">shader</span> <span class="p">=</span> <span class="n">m_Settings</span><span class="p">.</span><span class="n">rainDropShader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">mainKernel</span> <span class="p">=</span> <span class="n">shader</span><span class="p">.</span><span class="n">FindKernel</span><span class="p">(</span><span class="s">&#34;ScreenSpaceRainDrop&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//sobel</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeTextureParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="n">mainKernel</span><span class="p">,</span> <span class="s">&#34;_InputColorTex&#34;</span><span class="p">,</span> <span class="n">cam</span><span class="p">.</span><span class="n">cameraColorTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeTextureParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="n">mainKernel</span><span class="p">,</span> <span class="s">&#34;_InputDepthTex&#34;</span><span class="p">,</span> <span class="n">cam</span><span class="p">.</span><span class="n">cameraDepthTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeTextureParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="n">mainKernel</span><span class="p">,</span> <span class="s">&#34;_NoiseTex&#34;</span><span class="p">,</span> <span class="n">m_Settings</span><span class="p">.</span><span class="n">noiseTex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeIntParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&#34;_Thickness&#34;</span><span class="p">,</span> <span class="n">m_Settings</span><span class="p">.</span><span class="n">thickness</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeFloatParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&#34;_EdgeThreshold&#34;</span><span class="p">,</span> <span class="n">m_Settings</span><span class="p">.</span><span class="n">sobelThreshold</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//noise</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeFloatParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&#34;_RainDropScale&#34;</span><span class="p">,</span> <span class="n">m_Settings</span><span class="p">.</span><span class="n">rainDropScale</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeIntParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&#34;_NoiseWidth&#34;</span><span class="p">,</span> <span class="n">m_Settings</span><span class="p">.</span><span class="n">noiseTex</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeIntParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&#34;_NoiseHeight&#34;</span><span class="p">,</span> <span class="n">m_Settings</span><span class="p">.</span><span class="n">noiseTex</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeVectorParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&#34;_Time&#34;</span><span class="p">,</span> <span class="n">Shader</span><span class="p">.</span><span class="n">GetGlobalVector</span><span class="p">(</span><span class="s">&#34;_Time&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeFloatParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&#34;_DropSpeed&#34;</span><span class="p">,</span> <span class="n">m_Settings</span><span class="p">.</span><span class="n">dropSpeed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeVectorParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&#34;_DropColor&#34;</span><span class="p">,</span> <span class="n">m_Settings</span><span class="p">.</span><span class="n">dropColor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//output</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeTextureParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="n">mainKernel</span><span class="p">,</span> <span class="s">&#34;_OutputTex&#34;</span><span class="p">,</span> <span class="n">m_ResultTex</span><span class="p">.</span><span class="n">Identifier</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeIntParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&#34;_Width&#34;</span><span class="p">,</span> <span class="n">renderingData</span><span class="p">.</span><span class="n">cameraData</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">scaledPixelWidth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">SetComputeIntParam</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&#34;_Height&#34;</span><span class="p">,</span> <span class="n">renderingData</span><span class="p">.</span><span class="n">cameraData</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">scaledPixelHeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">threadGroupX</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">CeilToInt</span><span class="p">(</span><span class="n">renderingData</span><span class="p">.</span><span class="n">cameraData</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">scaledPixelWidth</span> <span class="p">/</span> <span class="m">8.0f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">threadGroupY</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">CeilToInt</span><span class="p">(</span><span class="n">renderingData</span><span class="p">.</span><span class="n">cameraData</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">scaledPixelHeight</span> <span class="p">/</span> <span class="m">8.0f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">DispatchCompute</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="n">mainKernel</span><span class="p">,</span> <span class="n">threadGroupX</span><span class="p">,</span> <span class="n">threadGroupY</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">Blit</span><span class="p">(</span><span class="n">m_ResultTex</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cam</span><span class="p">.</span><span class="n">cameraColorTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">ExecuteCommandBuffer</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">CommandBufferPool</span><span class="p">.</span><span class="n">Release</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">Submit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">FrameCleanup</span><span class="p">(</span><span class="n">CommandBuffer</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span><span class="p">.</span><span class="n">ReleaseTemporaryRT</span><span class="p">(</span><span class="n">m_ResultTex</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><h3 id="final-code">Final Code</h3>
<p><a href="https://github.com/sky-haihai/XihePostProcessing/tree/master/ZeldaRainDrop">Git Repo</a></p>
<h2 id="improvement">Improvement</h2>
<p>There are a few things I can improve in the future:</p>
<ol>
<li>Change the effect to Layer-based or Object-based for some very specific effects. But it will cost more performance and Tears of the kindom didn&rsquo;t do that, so I guess it&rsquo;s not necessary.</li>
<li>Play with the noise map to get a better looking rain drop. For example, downscale the noise map to get more blurred rain drops and save performance.</li>
</ol>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://www.yaotian-huang.com/jp/tags/unity/">Unity</a></li>
      <li><a href="https://www.yaotian-huang.com/jp/tags/shader/">Shader</a></li>
      <li><a href="https://www.yaotian-huang.com/jp/tags/compute-shader/">Compute Shader</a></li>
      <li><a href="https://www.yaotian-huang.com/jp/tags/render-feature/">Render Feature</a></li>
      <li><a href="https://www.yaotian-huang.com/jp/tags/post-processing/">Post Processing</a></li>
      <li><a href="https://www.yaotian-huang.com/jp/tags/urp/">URP</a></li>
    </ul>

<div class="share-buttons">

    <a target="_blank" rel="noopener noreferrer" aria-label="share Recreating the Rain Drop Effect in The Legend of Zelda: TOTK on linkedin"
        href="https://www.linkedin.com/in/heycharlola/">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span> <del>Life 1%</del></span>
      
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
